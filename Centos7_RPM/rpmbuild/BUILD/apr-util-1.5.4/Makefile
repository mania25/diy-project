#
# Top-level Makefile for APRUTIL
#
CPP = gcc -E

# gets substituted into some targets
APRUTIL_MAJOR_VERSION=1
APRUTIL_DOTTED_VERSION=1.5.4

srcdir = .


INCLUDES = -I/home/mania25/rpmbuild/BUILD/apr-util-1.5.4/include -I/home/mania25/rpmbuild/BUILD/apr-util-1.5.4/include/private -I/usr/include/nss3 -I/usr/include/nspr4 -I/usr/include -I/usr/include/mysql  -I/usr/include/apr-1  
APRUTIL_LDFLAGS = 
APRUTIL_LIBS = -lexpat /usr/lib64/libapr-1.la -lrt -lcrypt -lpthread -ldl

TARGET_LIB = libaprutil-${APRUTIL_MAJOR_VERSION}.la
INSTALL_SUBDIRS =  
EXTRA_SOURCE_DIRS =  
APRUTIL_PCFILE = apr-util-$(APRUTIL_MAJOR_VERSION).pc
APU_CONFIG = apu-$(APRUTIL_MAJOR_VERSION)-config
INSTALL = /usr/bin/install -c
INSTALL_DATA = ${INSTALL} -m 644

APU_MODULES =   crypto/apr_crypto_openssl.la crypto/apr_crypto_nss.la dbd/apr_dbd_pgsql.la dbd/apr_dbd_mysql.la dbd/apr_dbd_sqlite3.la dbd/apr_dbd_freetds.la dbd/apr_dbd_odbc.la ldap/apr_ldap.la
LINK_MODULE = $(LIBTOOL) $(LTFLAGS) --mode=link $(CC) $(LT_LDFLAGS) $(ALL_CFLAGS) $(ALL_LDFLAGS) $(APRUTIL_LDFLAGS) -release $(APRUTIL_MAJOR_VERSION) -module -rpath $(APU_DSO_LIBDIR)
APU_DSO_LIBDIR = ${libdir}/apr-util-1

LT_VERSION = -version-info 5:4:5

EXTRA_OBJECTS = 

LDADD_dbd_pgsql = -L/usr/lib64 -lpq 
LDADD_dbd_oracle = 
LDADD_dbd_sqlite2 = 
LDADD_dbd_sqlite3 =  -lsqlite3
LDADD_dbd_mysql = -L/usr/lib64/mysql        -lmysqlclient_r -L/usr/lib64/mysql -lmysqlclient -lpthread -lz -lm -lssl -lcrypto -ldl
LDADD_dbd_freetds =  -lsybdb
LDADD_dbd_odbc = -L/usr/lib64 -lodbc -L/usr/lib64 -lodbc
LDADD_dbm_db = 
LDADD_dbm_gdbm = 
LDADD_dbm_ndbm = 
LDADD_ldap = -lldap -llber
LDADD_crypto_openssl =  -lssl -lcrypto
LDADD_crypto_nss = -lssl3 -lsmime3 -lnss3 -lnssutil3 -lplds4 -lplc4 -lnspr4 -lpthread -ldl   -lnspr4 -lnss3

TARGETS = $(TARGET_LIB) aprutil.exp apu-config.out $(APU_MODULES)

# bring in rules.mk for standard functionality
include /home/mania25/rpmbuild/BUILD/apr-util-1.5.4/build/rules.mk
include /home/mania25/rpmbuild/BUILD/apr-util-1.5.4/build-outputs.mk

CLEAN_SUBDIRS = test  

CLEAN_TARGETS = exports.c export_vars.c aprutil.exp .make.dirs apu-config.out
DISTCLEAN_TARGETS = config.cache config.log config.status libtool \
	include/private/apu_config.h include/private/apu_private.h \
	include/private/apu_select_dbm.h include/apr_ldap.h include/apu.h \
	export_vars.sh $(APU_CONFIG) build/rules.mk include/apu_want.h \
	apr-util.pc build/pkg/pkginfo
EXTRACLEAN_TARGETS = configure aclocal.m4 include/private/apu_config.h.in \
	exports.c build-outputs.mk \
	build/apr_common.m4 build/find_apr.m4 build/install.sh \
	build/config.guess build/config.sub

prefix=/usr
exec_prefix=/usr
bindir=/usr/bin
libdir=/usr/lib64
includedir=/usr/include/apr-1
top_srcdir=/home/mania25/rpmbuild/BUILD/apr-util-1.5.4
top_blddir=/home/mania25/rpmbuild/BUILD/apr-util-1.5.4

# Create apu-config script suitable for the install tree
apu-config.out: $(APU_CONFIG)
	sed 's,^\(location=\).*$$,\1installed,' < $(APU_CONFIG) > $@

install: $(TARGETS) install-modules
	$(APR_MKDIR) $(DESTDIR)$(includedir) $(DESTDIR)$(libdir)/pkgconfig \
		     $(DESTDIR)$(libdir) $(DESTDIR)$(bindir)
	for f in $(top_srcdir)/include/*.h $(top_blddir)/include/*.h; do \
		$(INSTALL_DATA) $${f} $(DESTDIR)$(includedir); \
	done
	$(INSTALL_DATA) apr-util.pc $(DESTDIR)$(libdir)/pkgconfig/$(APRUTIL_PCFILE)
	list='$(INSTALL_SUBDIRS)'; for i in $$list; do \
		( cd $$i ; $(MAKE) DESTDIR=$(DESTDIR) install ); \
	done
	$(LIBTOOL) --mode=install $(INSTALL) -m 755 $(TARGET_LIB) $(DESTDIR)$(libdir)
	$(INSTALL_DATA) aprutil.exp $(DESTDIR)$(libdir)
	$(INSTALL) -m 755 apu-config.out $(DESTDIR)$(bindir)/$(APU_CONFIG)

$(TARGET_LIB): $(OBJECTS) $(EXTRA_OBJECTS)
	$(LINK) -rpath $(libdir) $(OBJECTS) $(EXTRA_OBJECTS) $(ALL_LIBS) $(APRUTIL_LDFLAGS) $(APRUTIL_LIBS)

install-modules: install-modules-yes

install-modules-no:

install-modules-yes: $(APU_MODULES)
	$(APR_MKDIR) $(DESTDIR)$(APU_DSO_LIBDIR)
	@for m in $(APU_MODULES); do $(LIBTOOL) $(LT_LTFLAGS) $(LTFLAGS) --mode=install $(INSTALL) -m 755 $$m $(DESTDIR)$(APU_DSO_LIBDIR); done

exports.c: $(HEADERS)
	$(APR_MKEXPORT) $(HEADERS) > $@

export_vars.c: $(HEADERS)
	$(APR_MKVAREXPORT) $(HEADERS) > $@

aprutil.exp: exports.c export_vars.c
	@echo "#! libaprutil-${APRUTIL_MAJOR_VERSION}.so" > $@
	@echo "* This file was AUTOGENERATED at build time." >> $@
	@echo "* Please do not edit by hand." >> $@
	$(CPP) $(ALL_CPPFLAGS) $(ALL_INCLUDES) exports.c | grep "ap_hack_" | sed -e 's/^.*[)]\(.*\);$$/\1/' >> $@
	$(CPP) $(ALL_CPPFLAGS) $(ALL_INCLUDES) export_vars.c | sed -e 's/^\#[^!]*//' | sed -e '/^$$/d' >> $@

dox:
	doxygen $(top_srcdir)/docs/doxygen.conf

test: check
check: $(TARGET_LIB)
	cd test && $(MAKE) all check

.PHONY: install-modules install-modules-yes install-modules-no dox test check
